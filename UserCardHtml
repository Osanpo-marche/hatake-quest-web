<!--test>
<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8" />
    <!-- â˜…ã“ã“è¿½åŠ ï¼šã‚¹ãƒãƒ›ç”¨ã®æ‹¡å¤§ãƒ»ç¸®å°è¨­å®š -->
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ç•‘ã‚¯ã‚¨ã‚¹ãƒˆï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚«ãƒ¼ãƒ‰</title>
    <style>
  /* === å…¨ä½“ãƒ™ãƒ¼ã‚¹ === */
  body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    margin: 0;
    padding: 16px;
    background: #e8f2ff;     /* å°‘ã—ã ã‘é»„ã¿ãŒã‹ã£ãŸç•‘ã‚«ãƒ©ãƒ¼ */
    color: #333;
    font-size: 16px;         /* ãƒ™ãƒ¼ã‚¹ã‚’å°‘ã—å¤§ãã */
    line-height: 1.7;
    -webkit-text-size-adjust: 100%;
  }

  h1 {
    font-size: 20px;
    margin: 0 0 8px;
  }

  .subtitle {
    font-size: 13px;
    color: #666;
    margin-bottom: 16px;
  }

  /* === ã‚«ãƒ¼ãƒ‰ã‚³ãƒ³ãƒ†ãƒŠ === */
  .cards {
    display: flex;
    flex-direction: column;
    gap: 16px;
    width: 100%;          /* ç”»é¢å¹…ã„ã£ã±ã„ã« */
    max-width: 760px;     /* PC ã§ã¯åºƒã™ãé˜²æ­¢ */
    margin: 0 auto;
    padding: 0 8px;       /* ã‚¹ãƒãƒ›ã§å·¦å³ä½™ç™½ã‚’å°‘ã—ã ã‘ */
  }

  .card {
    background: #ffffff;
    border-radius: 14px;
    padding: 18px 18px;
    box-shadow: 0 3px 10px rgba(15, 23, 42, 0.12);
    border: 2px solid #b5d98a;  /* ç•‘ã‚°ãƒªãƒ¼ãƒ³ã®ç¸å–ã‚Š */
  }

  .cards h3 {
    font-size: 20px;
    font-weight: 600;
  }

  .cards h4 {
    font-size: 17px;
    font-weight: 600;
  }

  .level-title {
    font-size: 19px;
    font-weight: 700;
  }

  .user-name {
    font-size: 21px;
    font-weight: 700;
    margin-bottom: 4px;
  }

  /* === ãƒ¬ãƒ™ãƒ«å‘¨ã‚Šï¼ˆååˆºã£ã½ã„æ ï¼‰ === */
  .user-header-box {
    border-radius: 12px;
    border: 1px solid #d6ebc4;
    background: #f7fbf1;
    padding: 10px 12px 12px;
    margin-bottom: 10px;
  }

  .user-level {
    font-size: 19px;        /* ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚ˆã‚Šå°‘ã—å°ã•ã */
    font-weight: 700;
    margin: 4px 0 2px;
    color: #1f4d2e;
  }

  .user-count {
    font-size: 13px;
    color: #555;
    margin-bottom: 4px;
  }

  .user-level-en {
    font-size: 15px;        /* Beginner / Farm Trainee */
    font-weight: 700;
    color: #333;
    margin-top: 4px;
    margin-bottom: 4px;
  }

  .user-level-desc {
    font-size: 14px;        /* â”€â”€ ç•‘ã«åˆã‚ã¦ç«‹ã¡ã€åœŸã®æ„Ÿè§¦ã‚’çŸ¥ã£ãŸã€‚ */
    font-weight: 700;
    color: #35694b;
    margin-bottom: 10px;
    border-left: 3px solid #79a885;
    padding-left: 6px;
  }

  .desc {
    font-size: 15px;
    font-weight: 600;
    color: #467b35;         /* ç•‘ã‚‰ã—ã„ã‚°ãƒªãƒ¼ãƒ³ */
  }

  /* === ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¦‹å‡ºã— === */
  .section-title {
    font-size: 14px;
    font-weight: 700;
    margin: 10px 0 4px;
  }

  .section-sub {
    font-size: 12px;
    color: #555;
    margin-bottom: 4px;
  }

  /* === ã‚¹ã‚­ãƒ«ãƒªã‚¹ãƒˆ === */
  ul.skill-list {
    margin: 0 0 6px 0;
    padding: 0;
    list-style: none;
    font-size: 14px;    /* ã‚¹ã‚­ãƒ«åã‚’å°‘ã—å¤§ãã‚ã« */
  }

  .skill-item {
    display: flex;
    align-items: center;
    margin-bottom: 4px;
    border-bottom: 1px solid #e5e7eb;
    padding: 2px 0;
  }

  .skill-item:last-child {
    border-bottom: none;
  }

  .skill-name {
    flex: 0 0 auto;
  }

  /* ğŸŒ±ğŸŒ¿ğŸŒ¾ğŸŒ» ã‚¢ã‚¤ã‚³ãƒ³éƒ¨åˆ† */
  .skill-icons {
    flex: 0 0 auto;
    margin-left: 8px;
    font-size: 19px;   /* ã‚¢ã‚¤ã‚³ãƒ³ã‚‚å°‘ã—å¤§ãã */
    white-space: nowrap;
  }

  /* â˜…æ•°ï¼ˆå³ç«¯ï¼‰ */
  .skill-stars {
    margin-left: auto;
    font-size: 12px;
    color: #444;
    white-space: nowrap;
  }

  .note {
    font-size: 12px;
    color: #6b7280;
    margin: 4px 0 8px;
  }

  .badge-row {
    font-size: 13px;
    margin-bottom: 4px;
  }

  .badge-empty {
    font-size: 12px;
    color: #94a3b8;
  }

  .empty {
    font-size: 13px;
    color: #666;
  }
</style>
  </head>

  <body>
    <h1>ç•‘ã‚¯ã‚¨ã‚¹ãƒˆ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚«ãƒ¼ãƒ‰</h1>
    <div class="subtitle">
      ç•‘ã®å‚åŠ è¨˜éŒ²ã‹ã‚‰ã€ã€Œå­¦ã³ã®é‡ã€ã¨ã€Œã‚¹ã‚­ãƒ«ã®ç·´åº¦ã€ã‚’å¯è¦–åŒ–ã—ã¦ã„ã¾ã™ã€‚
    </div>

    <div id="loading">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
    <div id="error" style="display: none;"></div>
    <div id="cards" class="cards"></div>

    <script>
      /* â˜… ãƒ¬ãƒ™ãƒ« â†’ è‹±åï¼†èª¬æ˜ãƒãƒƒãƒ— */
      const levelDetailMap = {
        1: { en: "Beginner / Farm Trainee", desc: "ç•‘ã«åˆã‚ã¦ç«‹ã¡ã€åœŸã®æ„Ÿè§¦ã‚’çŸ¥ã£ãŸã€‚" },
        2: { en: "Farm Novice", desc: "è‰å–ã‚Šã‚„åç©«ä½“é¨“ã‚’çµŒã¦ã€ç•‘ã‚’ä½“ã§æ„Ÿã˜å§‹ã‚ã‚‹è€…ã€‚" },
        3: { en: "Harvest Warrior", desc: "åç©«ã®å–œã³ã‚’åŠ›ã«å¤‰ãˆã€ç•‘ä½œæ¥­ã«é‚é€²ã™ã‚‹è€…ã€‚" },
        4: { en: "Farm Knight", desc: "åœŸã‚„å¤©å€™ã€å­£ç¯€ã‚’ç†è§£ã—å§‹ã‚ã€è¦šæ‚Ÿã‚’æŒã¡å§‹ã‚ãŸæˆ¦å£«ã€‚" },
        5: { en: "Farm Mage", desc: "ä½œç‰©ã¨è‡ªç„¶ã®ç†ã«ã€æ„Ÿæ€§ã§æ°—ã¥ãå§‹ã‚ã—è€…ã€‚" },
        6: { en: "Dark Knight of the Field", desc: "é›¨ã®æ—¥ã‚‚æš‘ã•ã‚‚è¶Šãˆã€ç•‘ã®è£å´ã‚’çŸ¥ã‚‹è€…ã€‚" },
        7: { en: "Farm Sage", desc: "ä¸€å¹´ã‚’é€šã—ã¦åœŸã¨å­£ç¯€ã®å£°ã‚’èª­ã‚€æ™ºè€…ã€‚" },
        8: { en: "Farm Paladin", desc: "ä¸€å¹´ã‚’å®Œèµ°ã—ã€å…‰ã¨ä¿¡å¿µã§å°ãè€…ã€‚" }
      };

      // â˜… éš ã—ã‚¹ã‚­ãƒ«ï¼ˆâ˜…ãŒä»˜ãã¾ã§UIã«å‡ºã•ãªã„ï¼‰
      const SECRET_SKILLS = new Set([
        "ç•‘ãƒ˜ãƒ«ãƒ—",
        "æ•™ã‚ã‚Š / æ„Ÿè¬",
        "ã‚´ãƒŸæ‹¾ã„ / æ•´å‚™",
        "æ©Ÿæ¢°æ“ä½œ",
        "ãƒãƒ¼ãƒ–æ ½åŸ¹ / æ´»ç”¨",
        "è‰ãƒ»æ¤ç‰©è¦³å¯Ÿ",
        "åç©« â†’ èª¿ç† â†’ ç™ºè¡¨",
        "ç›´å£²æ‰€æ‰‹ä¼ã„",
        "æ–°è¦ãŠå®¢ç´¹ä»‹",
        "å–¶æ¥­ä¿¡é ¼æ§‹ç¯‰",
        "SNSç™ºä¿¡"
      ]);

      // ç”»é¢èª­ã¿è¾¼ã¿æ™‚ã« GAS ã®é–¢æ•°ã‚’å©ã
      window.addEventListener("load", function () {
        google.script.run
          .withSuccessHandler(onDataLoaded)
          .withFailureHandler(onDataError)
          .getSkillDataForWebCard();
      });

      function onDataLoaded(data) {
        const loading = document.getElementById("loading");
        const error = document.getElementById("error");
        const cards = document.getElementById("cards");

        loading.style.display = "none";
        error.style.display = "none";
        cards.innerHTML = "";

        if (!data || data.error) {
          error.style.display = "block";
          error.textContent =
            (data && data.message) || "ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
          return;
        }

        if (data.length === 0) {
          cards.innerHTML =
            '<div class="empty">è¡¨ç¤ºã§ãã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã¾ã›ã‚“ã€‚</div>';
          return;
        }

        data.forEach((user) => {
          const card = document.createElement("div");
          card.className = "card";

          const skills = Array.isArray(user.skills) ? user.skills : [];
          const badges = Array.isArray(user.badges) ? user.badges : [];

          // â˜… ãƒ¬ãƒ™ãƒ«è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆ
          const levelText =
            (user.title ? user.title + " " : "") +
            "(Lv." +
            (user.level || 1) +
            ")";

          // â˜… ãƒ¬ãƒ™ãƒ«è©³ç´°
          const level = user.level || 1;
          const levelInfo = levelDetailMap[level] || {};
          const levelEn = levelInfo.en || "";
          const levelDesc = levelInfo.desc || "";

          // â˜… ã‚¹ã‚­ãƒ«â˜…æ•°ãƒãƒƒãƒ—ï¼ˆã„ã¾ã¯ level ã‚’ãã®ã¾ã¾â˜…æ‰±ã„ï¼‰
          const levelByTitle = {};
          skills.forEach((s) => {
            if (!s || !s.title) return;
            levelByTitle[s.title] = s.level || 0;
          });

          const getStars = (label) => {
            const lv = levelByTitle[label];
            return typeof lv === "number" && lv > 0 ? lv : 0;
          };

          // ğŸŒ±ğŸŒ¿ğŸŒ¾ğŸŒ» ã®æ®µéšï¼ˆã„ã¾ã¯â˜…1ã€œ5 / 6ã€œ10 / 11ã€œ15 / 16ã€œï¼‰
          function buildSkillIcons(stars) {
            if (stars <= 0) return "";
            let icon = "ğŸŒ±";
            if (stars >= 6 && stars <= 10) icon = "ğŸŒ¿";
            else if (stars >= 11 && stars <= 15) icon = "ğŸŒ¾";
            else if (stars >= 16) icon = "ğŸŒ»";

            const count = Math.min(stars, 5); // ä¸¦ã¹ã™ãé˜²æ­¢
            return icon.repeat(count);
          }

          // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã®è¡¨ç¤ºãƒ©ãƒ™ãƒ«
          const ENTRY = ["ç•ç«‹ã¦", "ç¨®ã¾ã / æ¤ä»˜", "é›‘è‰ã¨ã‚Š", "æ°´ã‚„ã‚Š"];
          const BASIC = ["åç©«", "æ”¯æŸ±çµ„ã¿", "ãƒ­ãƒ¼ãƒ—çµã³"];
          const INTER = [
            "ä»•ç«‹ã¦ / èª˜å¼• / å‰ªå®š",
            "ç•‘ãƒ˜ãƒ«ãƒ—",
            "æ•™ã‚ã‚Š / æ„Ÿè¬",
            "ã‚´ãƒŸæ‹¾ã„ / æ•´å‚™",
            "æ©Ÿæ¢°æ“ä½œ"
          ];
          const ADV = [
            "æ—¥èªŒã«è¨˜éŒ²",
            "ãƒãƒ¼ãƒ–æ ½åŸ¹ / æ´»ç”¨",
            "è‰ãƒ»æ¤ç‰©è¦³å¯Ÿ",
            "åç©« â†’ èª¿ç† â†’ ç™ºè¡¨"
          ];
          const UNIQUE = [
            "ç›´å£²æ‰€æ‰‹ä¼ã„",
            "æ–°è¦ãŠå®¢ç´¹ä»‹",
            "å–¶æ¥­ä¿¡é ¼æ§‹ç¯‰",
            "SNSç™ºä¿¡"
          ];

          // â˜… éš ã—ã‚¹ã‚­ãƒ«å¯¾å¿œã®ãƒªã‚¹ãƒˆæç”»ï¼ˆ1ã‚«ãƒ†ã‚´ãƒªåˆ†ï¼‰
          const renderSkillList = (labels) =>
            labels
              .filter((label) => {
                if (!SECRET_SKILLS.has(label)) return true;
                return getStars(label) > 0; // éš ã—ã‚¹ã‚­ãƒ«ã¯â˜…1ä»¥ä¸Šã§è§£ç¦
              })
              .map((label) => {
                const stars = getStars(label);
                const icons = buildSkillIcons(stars);
                return `
                  <li class="skill-item">
                    <span class="skill-name">${escapeHtml(label)}</span>
                    <span class="skill-icons">${icons}</span>
                    <span class="skill-stars">(${stars > 0 ? "â˜…" + stars : "â˜…0"})</span>
                  </li>
                `;
              })
              .join("");

          // â˜… ãƒãƒƒã‚¸HTML
          const badgesHtml =
            badges.length === 0
              ? '<div class="badge-empty">ã¾ã ãƒãƒƒã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>'
              : badges
                  .map((b) => {
                    const name = escapeHtml(b.badgeName || "");
                    const desc = escapeHtml(b.description || "");
                    const category = escapeHtml(b.category || "");
                    const date = escapeHtml(b.updatedAt || "");

                    const catJpMap = {
                      entry: "å…¥é–€",
                      basic: "åŸºæœ¬",
                      intermediate: "å¿œç”¨",
                      advance: "æ¢ç©¶",
                      unique: "ç‰¹å‹™",
                      legendary: "ä¼èª¬"
                    };
                    const catJp = catJpMap[category] || category;

                    return `
                      <div class="badge-row">
                        <strong>${name}</strong><br>
                        <span style="font-size:11px; color:#444;">
                          ${catJp}ï¼ˆ${category}ï¼‰
                        </span><br>
                        ${
                          desc
                            ? `<span style="font-size:11px;">â”€â”€ ${desc}</span><br>`
                            : ""
                        }
                        ${
                          date
                            ? `<span style="font-size:11px; color:#666;">èªå®šæ—¥ï¼š${date}</span>`
                            : ""
                        }
                      </div>
                      <div style="height:10px;"></div>
                    `;
                  })
                  .join("");

          // â˜… ã‚«ãƒ¼ãƒ‰å…¨ä½“ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
          card.innerHTML = `
  <div class="user-name">${escapeHtml(user.userName || "")}</div>

  <div class="user-header-box">
    <div class="user-level">
      ç¾åœ¨ã®ãƒ¬ãƒ™ãƒ«ï¼š${escapeHtml(levelText)}
    </div>
    <div class="user-count">
      æŠ•ç¨¿å›æ•°&ã‚¹ã‚­ãƒ«å­¦ç¿’â˜…ï¼š${user.currentExp ?? 0}
    </div>
    ${
      levelEn
        ? `<div class="user-level-en">${escapeHtml(levelEn)}</div>`
        : ""
    }
    ${
      levelDesc
        ? `<div class="user-level-desc">â”€â”€ ${escapeHtml(levelDesc)}</div>`
        : ""
    }
  </div>

            <div class="section-title">ğŸŒ± Skill Progressï¼ˆã‚¹ã‚­ãƒ«ç·´åº¦ï¼‰</div>
            <div class="note">
              â€» ã“ã®ã‚«ãƒ¼ãƒ‰ã«ã¯ã€ä½“é¨“ã‚’é‡ã­ã‚‹ã“ã¨ã§ç¾ã‚Œã‚‹ã€Œéš ã—ã‚¹ã‚­ãƒ«ã€ã‚‚ã‚ã‚Šã¾ã™ã€‚
            </div>

            <div class="section-title">Entryï¼ˆå…¥é–€ã‚¹ã‚­ãƒ«ï¼‰</div>
            <div class="section-sub">ç•‘ã«è§¦ã‚Œã‚‹æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ã€‚</div>
            <ul class="skill-list">
              ${renderSkillList(ENTRY)}
            </ul>

            <div class="section-title">Basicï¼ˆåŸºæœ¬ã‚¹ã‚­ãƒ«ï¼‰</div>
            <div class="section-sub">ä¸€äººã§å®‰å…¨ã«å‹•ã‘ã‚‹åŸºç¤æŠ€è¡“ã€‚</div>
            <ul class="skill-list">
              ${renderSkillList(BASIC)}
            </ul>

            <div class="section-title">Intermediateï¼ˆå¿œç”¨ã‚¹ã‚­ãƒ«ï¼‰</div>
            <div class="section-sub">çŠ¶æ³åˆ¤æ–­ãƒ»å·¥å¤«ãŒæ±‚ã‚ã‚‰ã‚Œã‚‹ã‚¹ã‚­ãƒ«ã€‚</div>
            ${
              INTER.length === 0
                ? '<div class="note">ã¾ã ã“ã®åˆ†é‡ã®ã‚¹ã‚­ãƒ«ã¯èŠ½å¹ã„ã¦ã„ã¾ã›ã‚“ã€‚</div>'
                : `<ul class="skill-list">${renderSkillList(INTER)}</ul>`
            }

            <div class="section-title">Advancedï¼ˆæ¢ç©¶ã‚¹ã‚­ãƒ«ï¼‰</div>
            <div class="section-sub">è¦³å¯Ÿãƒ»è¨˜éŒ²ãƒ»é‹å–¶ãªã©ã€æœ¬è³ªã«è¿‘ã¥ãå­¦ã³ã€‚</div>
            ${
              ADV.length === 0
                ? '<div class="note">ã¾ã ã“ã®åˆ†é‡ã®ã‚¹ã‚­ãƒ«ã¯èŠ½å¹ã„ã¦ã„ã¾ã›ã‚“ã€‚</div>'
                : `<ul class="skill-list">${renderSkillList(ADV)}</ul>`
            }

            <div class="section-title">Uniqueï¼ˆç‰¹åˆ¥ã‚¹ã‚­ãƒ«ï¼‰</div>
            <div class="section-sub">ç•‘ã§ã®å®Ÿè·µã¨å‰µé€ æ€§ã‹ã‚‰ç”Ÿã¾ã‚Œã‚‹ç‰¹åˆ¥ãªã‚¹ã‚­ãƒ«ã€‚</div>
            ${
              renderSkillList(UNIQUE)
                ? `<ul class="skill-list">${renderSkillList(
                    UNIQUE
                  )}</ul>`
                : '<div class="note">ã¾ã ã“ã®åˆ†é‡ã®ã‚¹ã‚­ãƒ«ã¯èŠ½å¹ã„ã¦ã„ã¾ã›ã‚“ã€‚</div>'
            }

            <div class="section-title">Earned Badgesï¼ˆç¿’å¾—ã—ãŸã‚¹ã‚­ãƒ«ï¼‰</div>
            <div class="note">
              ãƒãƒƒã‚¸ã¯ã€å¸«åŒ ãŒã€Œä»»ã›ã‚‰ã‚Œã‚‹ã€ã¨åˆ¤æ–­ã—ãŸã¨ãã«æˆä¸ã•ã‚Œã¾ã™ã€‚
            </div>
            ${badgesHtml}
          `;

          cards.appendChild(card);
        });
      }

      function onDataError(err) {
        const loading = document.getElementById("loading");
        const error = document.getElementById("error");
        loading.style.display = "none";
        error.style.display = "block";
        error.textContent =
          "ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼: " +
          (err && err.message ? err.message : err);
      }

      // XSSå¯¾ç­–ç”¨ã®ç°¡æ˜“ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
      function escapeHtml(str) {
        return String(str || "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }
    </script>
  </body>
</html>